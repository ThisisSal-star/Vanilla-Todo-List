<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vanilla To-Do List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --border:#1f2937;

      --light-bg:#f6f7fb;
      --light-card:#fff;
      --light-text:#0f172a;
      --light-muted:#6b7280;
      --light-border:#e5e7eb;
    }
    [data-theme="light"]{
      --bg:var(--light-bg);
      --card:var(--light-card);
      --text:var(--light-text);
      --muted:var(--light-muted);
      --border:var(--light-border);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
    }
    .app{max-width:960px;width:100%;padding:24px 16px 48px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
    .title{font-size:clamp(20px,2.6vw,28px);font-weight:700;}
    button{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{opacity:.9}
    .btn-accent{background:linear-gradient(to right,#10b981,#059669);border:none}
    .btn-danger{background:#991b1b;border:none}
    .btn-outline{background:transparent}
    .toolbar{display:grid;grid-template-columns:1fr 160px 180px 140px;gap:8px;margin:16px 0;}
    input,select,textarea{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      width:100%;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin-bottom:18px;
      display:grid;
      gap:10px;
    }
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .muted{color:var(--muted);}
    .sr-only{
      position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .checkbox{width:20px;height:20px;margin-top:4px;border:2px solid var(--border);
      border-radius:6px;display:grid;place-items:center;cursor:pointer;}
    .checkbox.checked{border-color:#065f46}
    .dot{width:12px;height:12px;border-radius:4px;background:var(--accent);opacity:0;transition:.15s;}
    .checkbox.checked .dot{opacity:1}
    .todo{flex:1}
    .todo-title{margin:0 0 6px;font-weight:700}
    .todo-desc{margin:0 0 8px;color:var(--muted);white-space:pre-wrap}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12.5px;color:var(--muted)}
    .chip{border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .chip.overdue{border-color:var(--danger);color:var(--danger)}
    .chip.complete{border-color:#065f46;color:#10b981}
    .chip.due{border-color:var(--warn);color:var(--warn)}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .struck .todo-title,.struck .todo-desc{text-decoration:line-through;opacity:.6}
    .overdue .todo-title{color:#fca5a5}
    .empty{text-align:center;color:var(--muted);border:1px dashed var(--border);
      border-radius:14px;padding:28px 14px;}
    .loading{opacity:.6;pointer-events:none}
    @media(max-width:820px){.toolbar{grid-template-columns:1fr 1fr}}
    @media(max-width:480px){.grid-2{grid-template-columns:1fr}}
    .toast{
      position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;
      border:1px solid #374151;padding:12px 14px;border-radius:12px;
      opacity:0;transform:translateY(8px);
      transition:opacity .2s,transform .2s;z-index:50;
    }
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body data-theme="light">
  <div class="app">
    <div class="topbar">
      <div class="title">To-Do List</div>
      <div class="actions">
        <button id="themeBtn" class="btn btn-outline" type="button" title="Toggle theme">üåó Theme</button>
        <button id="reloadBtn" class="btn btn-outline" type="button">‚Üª Refresh</button>
      </div>
    </div>

    <!-- Create / Edit Panel -->
    <form id="createForm" class="panel" autocomplete="off">
      <div class="grid-2">
        <div>
          <label for="titleInput" class="sr-only">Task title</label>
          <input id="titleInput" name="title" placeholder="Task title *" required />
        </div>
        <div>
          <label for="dueInput" class="sr-only">Due date and time</label>
          <input id="dueInput" name="due" type="datetime-local" required />
        </div>
      </div>
      <label for="descInput" class="sr-only">Description</label>
      <textarea id="descInput" name="description" placeholder="Description (optional)"></textarea>
      <div class="inline">
        <button id="saveBtn" class="btn btn-accent" type="submit">‚ûï Add Task</button>
        <span id="formStatus" class="muted" role="status" aria-live="polite"></span>
      </div>
    </form>

    <!-- Toolbar -->
    <div class="toolbar">
      <div>
        <label for="searchInput" class="sr-only">Search tasks</label>
        <input id="searchInput" type="search" placeholder="Search title or description‚Ä¶" />
      </div>
      <select id="filterSelect" aria-label="Filter tasks">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
        <option value="overdue">Overdue</option>
      </select>
      <select id="sortSelect" aria-label="Sort tasks">
        <option value="dueAsc">Sort by Due ‚Üë</option>
        <option value="dueDesc">Sort by Due ‚Üì</option>
        <option value="createdDesc">Newest First</option>
        <option value="createdAsc">Oldest First</option>
      </select>
      <button id="clearCompletedBtn" class="btn btn-outline" type="button">Clear Completed</button>
    </div>

    <!-- List -->
    <div id="list" class="list"></div>
    <div id="emptyState" class="empty" hidden>No tasks yet. Add your first one ‚ú®</div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const API_BASE = 'http://localhost:3000';
    let TODOS=[], NOTIFY_TIMERS=new Map();
    const els={
      list:document.getElementById('list'),
      empty:document.getElementById('emptyState'),
      createForm:document.getElementById('createForm'),
      titleInput:document.getElementById('titleInput'),
      descInput:document.getElementById('descInput'),
      dueInput:document.getElementById('dueInput'),
      formStatus:document.getElementById('formStatus'),
      saveBtn:document.getElementById('saveBtn'),
      reloadBtn:document.getElementById('reloadBtn'),
      themeBtn:document.getElementById('themeBtn'),
      searchInput:document.getElementById('searchInput'),
      filterSelect:document.getElementById('filterSelect'),
      sortSelect:document.getElementById('sortSelect'),
      clearCompletedBtn:document.getElementById('clearCompletedBtn'),
      toast:document.getElementById('toast')
    };
    const isOverdue=t=>!t.completed&&new Date(t.dueAt)<new Date();
    const fmt=v=>new Date(v).toLocaleString([],{
      year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'
    });
    const showToast=m=>{
      els.toast.textContent=m;
      els.toast.classList.add('show');
      setTimeout(()=>els.toast.classList.remove('show'),2200);
    };
    const setLoading=s=>{
      document.querySelector('.app').classList.toggle('loading',s);
      document.documentElement.style.cursor=s?'progress':'default';
    };
    function buildQuery(){
      const q=els.searchInput.value.trim().toLowerCase();
      const f=els.filterSelect.value;
      const s=els.sortSelect.value;
      let arr=TODOS.slice();
      if(q)arr=arr.filter(t=>t.title.toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q));
      if(f==='completed')arr=arr.filter(t=>t.completed);
      if(f==='pending')arr=arr.filter(t=>!t.completed&&!isOverdue(t));
      if(f==='overdue')arr=arr.filter(isOverdue);
      arr.sort((a,b)=>{
        if(s==='dueAsc')return new Date(a.dueAt)-new Date(b.dueAt);
        if(s==='dueDesc')return new Date(b.dueAt)-new Date(a.dueAt);
        if(s==='createdAsc')return new Date(a.createdAt)-new Date(b.createdAt);
        if(s==='createdDesc')return new Date(b.createdAt)-new Date(a.createdAt);
        return 0;
      });
      return arr;
    }
    function scheduleNotification(t){
      if(NOTIFY_TIMERS.has(t.id)){clearTimeout(NOTIFY_TIMERS.get(t.id));NOTIFY_TIMERS.delete(t.id);}
      if(t.completed)return;
      const ms=new Date(t.dueAt).getTime()-Date.now();
      if(ms<=0)return;
      const timer=setTimeout(()=>{
        alert(`‚è∞ Due now: ${t.title}`);showToast(`Due now: ${t.title}`);
        NOTIFY_TIMERS.delete(t.id);
      },ms);
      NOTIFY_TIMERS.set(t.id,timer);
    }
    function scheduleAll(){NOTIFY_TIMERS.forEach(clearTimeout);NOTIFY_TIMERS.clear();TODOS.forEach(scheduleNotification);}
    function render(){
      const items=buildQuery();
      els.list.innerHTML='';
      if(items.length===0){els.empty.hidden=false;return;}
      els.empty.hidden=true;
      for(const t of items){
        const c=document.createElement('div');
        const overdue=isOverdue(t);
        c.className='card '+(t.completed?'struck ':'')+(overdue?'overdue ':'');
        const cb=document.createElement('label');
        cb.className='checkbox'+(t.completed?' checked':'');
        cb.innerHTML='<input type="checkbox"/><div class="dot"></div>';
        cb.addEventListener('click',e=>{e.preventDefault();toggleComplete(t);});
        const main=document.createElement('div');
        main.className='todo';
        main.innerHTML=`<h3 class="todo-title">${t.title}</h3>
          ${t.description?`<p class="todo-desc">${t.description}</p>`:''}`;
        const meta=document.createElement('div');
        meta.className='meta';
        const chip1=document.createElement('span');
        chip1.className='chip '+(t.completed?'complete':(overdue?'overdue':'due'));
        chip1.textContent=t.completed?'Completed':(overdue?'Overdue':'Due: '+fmt(t.dueAt));
        const chip2=document.createElement('span');
        chip2.className='chip';chip2.textContent='Created: '+fmt(t.createdAt);
        meta.append(chip1,chip2);
        main.append(meta);
        const actions=document.createElement('div');
        actions.className='card-actions';
        const edit=document.createElement('button');
        edit.textContent='‚úèÔ∏è Edit';edit.className='btn';edit.type='button';
        edit.addEventListener('click',()=>openEdit(t));
        const del=document.createElement('button');
        del.textContent='üóë Delete';del.className='btn btn-danger';del.type='button';
        del.addEventListener('click',async()=>{
          if(!confirm(`Delete "${t.title}"?`))return;
          setLoading(true);
          try{await apiDelete(t.id);TODOS=TODOS.filter(x=>x.id!==t.id);render();showToast('Deleted');}
          catch(e){alert('Delete failed');console.error(e);}
          finally{setLoading(false);}
        });
        actions.append(edit,del);
        c.append(cb,main,actions);
        els.list.append(c);
      }
      scheduleAll();
    }
    const apiGet=()=>fetch(`${API_BASE}/todos`).then(r=>r.json());
    const apiPost=t=>fetch(`${API_BASE}/todos`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(t)}).then(r=>r.json());
    const apiPut=(id,t)=>fetch(`${API_BASE}/todos/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(t)}).then(r=>r.json());
    const apiDelete=id=>fetch(`${API_BASE}/todos/${id}`,{method:'DELETE'});
    els.createForm.addEventListener('submit',async e=>{
      e.preventDefault();
      const title=els.titleInput.value.trim();
      const desc=els.descInput.value.trim();
      const due=els.dueInput.value;
      if(!title||!due){alert('Title and due date required');return;}
      const newTodo={title,description:desc,completed:false,
        createdAt:new Date().toISOString(),dueAt:new Date(due).toISOString()};
      setLoading(true);els.formStatus.textContent='Saving‚Ä¶';
      try{
        const saved=await apiPost(newTodo);
        TODOS.unshift(saved);els.createForm.reset();render();showToast('Added');
      }catch(err){alert('Save failed');console.error(err);}
      finally{els.formStatus.textContent='';setLoading(false);}
    });
    async function toggleComplete(t){
      setLoading(true);
      try{
        const up=await apiPut(t.id,{...t,completed:!t.completed});
        TODOS[TODOS.findIndex(x=>x.id===t.id)]=up;render();
        showToast(up.completed?'Marked complete':'Marked incomplete');
      }catch(e){alert('Update failed');}
      finally{setLoading(false);}
    }
    function openEdit(t){
      els.titleInput.value=t.title;
      els.descInput.value=t.description||'';
      const d=new Date(t.dueAt),p=n=>String(n).padStart(2,'0');
      els.dueInput.value=`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
      els.saveBtn.textContent='üíæ Update Task';
      els.formStatus.textContent='Editing‚Ä¶';
      els.createForm.onsubmit=async e=>{
        e.preventDefault();
        const title=els.titleInput.value.trim(),desc=els.descInput.value.trim(),due=els.dueInput.value;
        if(!title||!due){alert('Title and due date required');return;}
        setLoading(true);els.formStatus.textContent='Updating‚Ä¶';
        try{
          const up=await apiPut(t.id,{...t,title,description:desc,dueAt:new Date(due).toISOString()});
          TODOS[TODOS.findIndex(x=>x.id===t.id)]=up;render();showToast('Updated');
          els.createForm.reset();els.saveBtn.textContent='‚ûï Add Task';els.formStatus.textContent='';
          els.createForm.onsubmit=null;
        }catch(err){alert('Update failed');}
        finally{setLoading(false);}
      };
    }
    els.reloadBtn.addEventListener('click',load);
    els.themeBtn.addEventListener('click',()=>{
      document.body.dataset.theme=document.body.dataset.theme==='light'?'dark':'light';
    });
    els.searchInput.addEventListener('input',render);
    els.filterSelect.addEventListener('change',render);
    els.sortSelect.addEventListener('change',render);
    els.clearCompletedBtn.addEventListener('click',async()=>{
      const done=TODOS.filter(t=>t.completed);
      if(!done.length){showToast('Nothing to clear');return;}
    